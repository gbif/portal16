'use strict';
let express = require('express'),
    router = express.Router(),
    log = rootRequire('config/log'),
    url = require('url'),
    minute = 60,
    hour = 60 * minute,
    _ = require('lodash'),
    getGeoIp = rootRequire('app/helpers/utils').getGeoIp;

module.exports = function(app) {
    app.use('/api/utils', router);
};

router.get('/geoip', function(req, res) {
    let ip = getIp(req, res),
        country = getGeoIp(ip);

    if (!country) {
        log.debug('unable to match ip to country using ip: ' + ip);
        res.setHeader('Cache-Control', 'no-cache');
        res.status(404);
        res.send();
    } else {
        res.setHeader('Cache-Control', 'private, max-age=' + hour);
        res.json({country: country});
    }
});

router.get('/geoip/country', function(req, res) {
    let ip = getIp(req, res),
        country = getGeoIp(ip),
        countryCode = _.get(country, 'country.iso_code');

    if (!countryCode) {
        log.debug('unable to match ip to country using ip: ' + ip);
        res.setHeader('Cache-Control', 'no-cache');
        res.status(204);
        res.send();
    } else {
        res.setHeader('Cache-Control', 'private, max-age=' + hour);
        let location = countryCodes2CrudeCoordinates[countryCode];
        res.json({
            countryCode: countryCode,
            location: location
        });
    }
});

function getIp(req, res) {
    let referer = _.get(req, 'headers.referer');
    if (!referer) {
        res.setHeader('Cache-Control', 'no-cache');
        res.status(404);
        res.send();
        return;
    }
    let parsedReferer = url.parse(referer, true),
        mockIp = _.get(parsedReferer, 'query.mockip'),
        ip = mockIp || req.clientIp;
    return ip;
}

// We need a better geolocation and service. But that shouldn't be a part of the portal project.
// No one seems to have time nor interest in implementing such at this point.
// I have created a crude unmaintained one based on a database dump instead.
// and now supplemented it with a country code to rought location.
// It isn't pretty but will serve as a test for whether this is something that could be interesting to continue with
let countryCodes2CrudeCoordinates = {
    'AF': [33.93911, 67.709953],
    'AX': [37.0625, -95.677068],
    'AL': [41.153332, 20.168331],
    'DZ': [28.033886, 1.659626],
    'AS': [-14.270972, -170.132217],
    'AD': [42.546245, 1.601554],
    'AO': [-11.202692, 17.873887],
    'AI': [18.220554, -63.068615],
    'AQ': [-75.250973, -0.071389],
    'AG': [17.060816, -61.796428],
    'AR': [-38.416097, -63.616672],
    'AM': [40.069099, 45.038189],
    'AW': [12.52111, -69.968338],
    'AU': [-25.274398, 133.775136],
    'AT': [47.516231, 14.550072],
    'AZ': [40.143105, 47.576927],
    'BS': [25.03428, -77.39628],
    'BH': [25.930414, 50.637772],
    'BD': [23.684994, 90.356331],
    'BB': [13.193887, -59.543198],
    'BY': [53.709807, 27.953389],
    'BE': [50.503887, 4.469936],
    'BZ': [17.189877, -88.49765],
    'BJ': [9.30769, 2.315834],
    'BM': [32.321384, -64.75737],
    'BT': [27.514162, 90.433601],
    'BO': [-16.290154, -63.588653],
    'BA': [43.915886, 17.679076],
    'BW': [-22.328474, 24.684866],
    'BV': [-54.423199, 3.413194],
    'BR': [-14.235004, -51.92528],
    'IO': [-6.343194, 71.876519],
    'BN': [4.535277, 114.727669],
    'BG': [42.733883, 25.48583],
    'BF': [12.238333, -1.561593],
    'BI': [-3.373056, 29.918886],
    'KH': [12.565679, 104.990963],
    'CM': [7.369722, 12.354722],
    'CA': [56.130366, -106.346771],
    'CV': [16.002082, -24.013197],
    'KY': [19.513469, -80.566956],
    'CF': [6.611111, 20.939444],
    'TD': [15.454166, 18.732207],
    'CL': [-35.675147, -71.542969],
    'CN': [35.86166, 104.195397],
    'CX': [-10.447525, 105.690449],
    'CC': [37.0625, -95.677068],
    'CO': [4.570868, -74.297333],
    'KM': [-11.875001, 43.872219],
    'CG': [-0.228021, 15.827659],
    'CD': [-0.228021, 15.827659],
    'CK': [-21.236736, -159.777671],
    'CR': [9.748917, -83.753428],
    'CI': [7.539989, -5.54708],
    'HR': [45.1, 15.2],
    'CU': [21.521757, -77.781167],
    'CY': [35.126413, 33.429859],
    'CZ': [49.817492, 15.472962],
    'DK': [56.26392, 9.501785],
    'DJ': [11.825138, 42.590275],
    'DM': [15.414999, -61.370976],
    'DO': [18.735693, -70.162651],
    'EC': [-1.831239, -78.183406],
    'EG': [26.820553, 30.802498],
    'SV': [13.794185, -88.89653],
    'GQ': [1.650801, 10.267895],
    'ER': [15.179384, 39.782334],
    'EE': [58.595272, 25.013607],
    'ET': [9.145, 40.489673],
    'FK': [-51.796253, -59.523613],
    'FO': [61.892635, -6.911806],
    'FJ': [-16.578193, 179.414413],
    'FI': [61.92411, 25.748151],
    'FR': [46.227638, 2.213749],
    'GF': [3.933889, -53.125782],
    'PF': [-17.679742, -149.406843],
    'TF': [37.0625, -95.677068],
    'GA': [-0.803689, 11.609444],
    'GM': [13.443182, -15.310139],
    'GE': [32.157435, -82.907123],
    'DE': [51.165691, 10.451526],
    'GH': [7.946527, -1.023194],
    'GI': [36.137741, -5.345374],
    'GR': [39.074208, 21.824312],
    'GL': [71.706936, -42.604303],
    'GD': [12.262776, -61.604171],
    'GP': [16.995971, -62.067641],
    'GU': [13.444304, 144.793731],
    'GT': [15.783471, -90.230759],
    'GG': [49.465691, -2.585278],
    'GN': [9.945587, -9.696645],
    'GW': [11.803749, -15.180413],
    'GY': [4.860416, -58.93018],
    'HT': [18.971187, -72.285215],
    'HM': [-53.08181, 73.504158],
    'VA': [37.0625, -95.677068],
    'HN': [15.199999, -86.241905],
    'HK': [22.396428, 114.109497],
    'HU': [47.162494, 19.503304],
    'IS': [64.963051, -19.020835],
    'IN': [20.593684, 78.96288],
    'ID': [-0.789275, 113.921327],
    'IR': [32.427908, 53.688046],
    'IQ': [33.223191, 43.679291],
    'IE': [53.41291, -8.24389],
    'IM': [54.236107, -4.548056],
    'IL': [31.046051, 34.851612],
    'IT': [41.87194, 12.56738],
    'JM': [18.109581, -77.297508],
    'JP': [36.204824, 138.252924],
    'JE': [49.214439, -2.13125],
    'JO': [30.585164, 36.238414],
    'KZ': [48.019573, 66.923684],
    'KE': [-0.023559, 37.906193],
    'KI': [-3.370417, -168.734039],
    'KP': [35.907757, 127.766922],
    'KR': [35.907757, 127.766922],
    'KW': [29.31166, 47.481766],
    'KG': [41.20438, 74.766098],
    'LA': [19.85627, 102.495496],
    'LV': [56.879635, 24.603189],
    'LB': [33.854721, 35.862285],
    'LS': [-29.609988, 28.233608],
    'LR': [6.428055, -9.429499],
    'LY': [37.0625, -95.677068],
    'LI': [47.166, 9.555373],
    'LT': [55.169438, 23.881275],
    'LU': [49.815273, 6.129583],
    'MO': [22.198745, 113.543873],
    'MK': [41.608635, 21.745275],
    'MG': [-18.766947, 46.869107],
    'MW': [-13.254308, 34.301525],
    'MY': [4.210484, 101.975766],
    'MV': [3.202778, 73.22068],
    'ML': [17.570692, -3.996166],
    'MT': [35.937496, 14.375416],
    'MH': [7.131474, 171.184478],
    'MQ': [14.641528, -61.024174],
    'MR': [21.00789, -10.940835],
    'MU': [-20.348404, 57.552152],
    'YT': [-12.8275, 45.166244],
    'MX': [23.634501, -102.552784],
    'FM': [7.425554, 150.550812],
    'MD': [47.411631, 28.369885],
    'MC': [43.750298, 7.412841],
    'MN': [46.862496, 103.846656],
    'ME': [42.708678, 19.37439],
    'MS': [16.742498, -62.187366],
    'MA': [31.791702, -7.09262],
    'MZ': [-18.665695, 35.529562],
    'MM': [21.913965, 95.956223],
    'NA': [-22.95764, 18.49041],
    'NR': [-0.522778, 166.931503],
    'NP': [28.394857, 84.124008],
    'NL': [52.132633, 5.291266],
    'AN': [12.226079, -69.060087],
    'NC': [-20.904305, 165.618042],
    'NZ': [-40.900557, 174.885971],
    'NI': [12.865416, -85.207229],
    'NE': [17.607789, 8.081666],
    'NG': [9.081999, 8.675277],
    'NU': [-19.054445, -169.867233],
    'NF': [-29.040835, 167.954712],
    'MP': [17.33083, 145.38469],
    'NO': [60.472024, 8.468946],
    'OM': [21.512583, 55.923255],
    'PK': [30.375321, 69.345116],
    'PW': [7.51498, 134.58252],
    'PS': [42.094445, 17.266614],
    'PA': [8.537981, -80.782127],
    'PG': [-6.314993, 143.95555],
    'PY': [-23.442503, -58.443832],
    'PE': [-9.189967, -75.015152],
    'PH': [12.879721, 121.774017],
    'PN': [-24.703615, -127.439308],
    'PL': [51.919438, 19.145136],
    'PT': [39.399872, -8.224454],
    'PR': [18.220833, -66.590149],
    'QA': [25.354826, 51.183884],
    'RE': [-21.115141, 55.536384],
    'RO': [45.943161, 24.96676],
    'RU': [61.52401, 105.318756],
    'RW': [-1.940278, 29.873888],
    'BL': [37.0625, -95.677068],
    'SH': [-24.143474, -10.030696],
    'KN': [17.357822, -62.782998],
    'LC': [13.909444, -60.978893],
    'MF': [43.589046, 5.885031],
    'PM': [46.941936, -56.27111],
    'VC': [12.984305, -61.287228],
    'WS': [-13.759029, -172.104629],
    'SM': [43.94236, 12.457777],
    'ST': [0.18636, 6.613081],
    'SA': [23.885942, 45.079162],
    'SN': [14.497401, -14.452362],
    'RS': [44.016521, 21.005859],
    'SC': [-4.679574, 55.491977],
    'SL': [8.460555, -11.779889],
    'SG': [1.352083, 103.819836],
    'SK': [48.669026, 19.699024],
    'SI': [46.151241, 14.995463],
    'SB': [-9.64571, 160.156194],
    'SO': [5.152149, 46.199616],
    'ZA': [-30.559482, 22.937506],
    'GS': [-54.429579, -36.587909],
    'ES': [40.463667, -3.74922],
    'LK': [7.873054, 80.771797],
    'SD': [12.862807, 30.217636],
    'SR': [3.919305, -56.027783],
    'SJ': [77.553604, 23.670272],
    'SZ': [-26.522503, 31.465866],
    'SE': [60.128161, 18.643501],
    'CH': [46.818188, 8.227512],
    'SY': [34.802075, 38.996815],
    'TW': [23.69781, 120.960515],
    'TJ': [38.861034, 71.276093],
    'TZ': [-6.369028, 34.888822],
    'TH': [15.870032, 100.992541],
    'TL': [-8.874217, 125.727539],
    'TG': [8.619543, 0.824782],
    'TK': [-8.967363, -171.855881],
    'TO': [-21.178986, -175.198242],
    'TT': [10.691803, -61.222503],
    'TN': [33.886917, 9.537499],
    'TR': [38.963745, 35.243322],
    'TM': [38.969719, 59.556278],
    'TC': [21.694025, -71.797928],
    'TV': [-7.109535, 177.64933],
    'UG': [1.373333, 32.290275],
    'UA': [48.379433, 31.16558],
    'AE': [23.424076, 53.847818],
    'GB': [55.378051, -3.435973],
    'US': [37.09024, -95.712891],
    'UM': [24.747346, -167.594906],
    'UY': [-32.522779, -55.765835],
    'UZ': [41.377491, 64.585262],
    'VU': [-15.376706, 166.959158],
    'VE': [6.42375, -66.58973],
    'VN': [14.058324, 108.277199],
    'VG': [18.335765, -64.896335],
    'VI': [18.335765, -64.896335],
    'WF': [-13.768752, -177.156097],
    'EH': [24.215527, -12.885834],
    'YE': [15.552727, 48.516388],
    'ZM': [-13.133897, 27.849332],
    'ZW': [-19.015438, 29.154857]
};
